# Local Development Docker Compose
# This file is for LOCAL DEVELOPMENT ONLY
# For Portainer deployment, use docker-compose.portainer.template.yml

services:
  # Backend API
  the-harry-list-backend:
    build:
      context: ./the-harry-list-backend
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    networks:
      - harry-list
      - mariadb_mariadb-network
    depends_on:
      - mariadb
    environment:
      # Spring Boot Configuration
      - SPRING_PROFILES_ACTIVE=dev
      - TZ=Europe/Amsterdam

      # Database Configuration - UPDATE for your local setup
      - SPRING_DATASOURCE_URL=jdbc:mariadb://mariadb:3306/harrylist
      - SPRING_DATASOURCE_USERNAME=harrylist_user
      - SPRING_DATASOURCE_PASSWORD=local_dev_password

      # JPA/Hibernate Configuration
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update
      - SPRING_JPA_DATABASE_PLATFORM=org.hibernate.dialect.MariaDBDialect
      - SPRING_JPA_SHOW_SQL=true

      # Security Configuration
      - SPRING_SECURITY_USER_NAME=admin
      - SPRING_SECURITY_USER_PASSWORD=admin

      # Azure AD Configuration (for JWT auth and Graph API)
      - AZURE_TENANT_ID=${AZURE_TENANT_ID:-}
      - AZURE_CLIENT_ID=${AZURE_CLIENT_ID:-}
      - AZURE_CLIENT_SECRET=${AZURE_CLIENT_SECRET:-}

      # Calendar ICS Feed Tokens (generate with: openssl rand -hex 32)
      - CALENDAR_FEED_TOKEN=${CALENDAR_FEED_TOKEN:-}
      - CALENDAR_FEED_STAFF_TOKEN=${CALENDAR_FEED_STAFF_TOKEN:-}

      # Logging
      - LOGGING_LEVEL_ROOT=INFO
      - LOGGING_LEVEL_COM_PIMVANLEEUWEN=DEBUG

  # Public Reservation Form Frontend
  the-harry-list-public:
    build:
      context: ./the-harry-list-public
      dockerfile: Dockerfile
    ports:
      - "5173:80"
    networks:
      - harry-list
    depends_on:
      - the-harry-list-backend
    environment:
      # Runtime configuration (injected at container startup)
      - API_URL=http://localhost:8080

  # Admin Portal Frontend
  the-harry-list-admin:
    build:
      context: ./the-harry-list-admin
      dockerfile: Dockerfile
    ports:
      - "5174:80"
    networks:
      - harry-list
    depends_on:
      - the-harry-list-backend
    environment:
      # Runtime configuration (injected at container startup)
      - API_URL=http://localhost:8080
      # Azure AD - set these in .env file for Microsoft login
      # Leave empty to use dev mode authentication with basic auth
      - AZURE_CLIENT_ID=${AZURE_CLIENT_ID:-}
      - AZURE_TENANT_ID=${AZURE_TENANT_ID:-}
      - REDIRECT_URI=http://localhost:5174
      - ALLOWED_GROUP_ID=${ALLOWED_GROUP_ID:-}

  # Local MariaDB for development
  mariadb:
    image: mariadb:latest
    restart: always
    ports:
      - "3306:3306"
    environment:
      MARIADB_ROOT_PASSWORD: rootpassword
      MARIADB_DATABASE: harrylist
      MARIADB_USER: harrylist_user
      MARIADB_PASSWORD: local_dev_password
    volumes:
      - mariadb_data:/var/lib/mysql
    networks:
      - mariadb_mariadb-network

volumes:
  mariadb_data:

networks:
  harry-list:
  mariadb_mariadb-network:
    external: false
