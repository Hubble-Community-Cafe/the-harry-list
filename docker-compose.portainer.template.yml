# Template for Portainer deployment
# Replace YOUR_GITHUB_USERNAME with your actual GitHub username (lowercase)
# Replace all __FILL_IN__ values with actual configuration

services:
  # Backend API
  the-harry-list-backend:
    image: ghcr.io/YOUR_GITHUB_USERNAME/the-harry-list-backend:latest
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
    ports:
      - "9802:8080"
    networks:
      - harry-list
      - mariadb_mariadb-network
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - TZ=Europe/Amsterdam

      # Database Configuration
      - SPRING_DATASOURCE_URL=jdbc:mariadb://mariadb:3306/harrylist
      - SPRING_DATASOURCE_USERNAME=__DB_USERNAME__
      - SPRING_DATASOURCE_PASSWORD=__DB_PASSWORD__
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update
      - SPRING_JPA_DATABASE_PLATFORM=org.hibernate.dialect.MariaDBDialect
      - SPRING_JPA_SHOW_SQL=false

      # Basic Auth for Admin API endpoints
      - SPRING_SECURITY_USER_NAME=__API_USERNAME__
      - SPRING_SECURITY_USER_PASSWORD=__API_PASSWORD__

      # Email Configuration (Microsoft Graph for Microsoft 365)
      # Set APP_MAIL_ENABLED=false to disable email notifications
      - APP_MAIL_ENABLED=true
      - APP_MAIL_FROM=noreply@hubble.cafe
      - APP_MAIL_STAFF=info@hubble.cafe
      - APP_BAR_NAME=Hubble and Meteor Community Cafes

      # Azure AD Configuration (for JWT auth and Graph API email)
      # Get these from Azure Portal > App registrations > Your App
      - AZURE_TENANT_ID=__AZURE_TENANT_ID__
      - AZURE_CLIENT_ID=__AZURE_CLIENT_ID__
      - AZURE_CLIENT_SECRET=__AZURE_CLIENT_SECRET__

      # Calendar ICS Feed Tokens (generate with: openssl rand -hex 32)
      # Public feed: no contact details, Staff feed: includes email/phone
      - CALENDAR_FEED_TOKEN=__CALENDAR_FEED_TOKEN__
      - CALENDAR_FEED_STAFF_TOKEN=__CALENDAR_FEED_STAFF_TOKEN__

      # CORS - Allowed origins (comma-separated, must match your frontend URLs)
      - CORS_ALLOWED_ORIGINS=https://harry.hubble.cafe,https://harry-admin.hubble.cafe

      # Logging
      - LOGGING_LEVEL_ROOT=INFO
      - LOGGING_LEVEL_COM_PIMVANLEEUWEN=DEBUG

  # Public Reservation Form Frontend
  the-harry-list-public:
    image: ghcr.io/YOUR_GITHUB_USERNAME/the-harry-list-public:latest
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
    ports:
      - "9803:80"
    networks:
      - harry-list
    environment:
      - API_URL=https://api.hubble.cafe

  # Admin Portal Frontend
  the-harry-list-admin:
    image: ghcr.io/YOUR_GITHUB_USERNAME/the-harry-list-admin:latest
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
    ports:
      - "9804:80"
    networks:
      - harry-list
    environment:
      # Backend API URL
      - API_URL=https://api.hubble.cafe
      # Azure AD Configuration for Microsoft Login
      - AZURE_CLIENT_ID=__AZURE_CLIENT_ID__
      - AZURE_TENANT_ID=__AZURE_TENANT_ID__
      - REDIRECT_URI=https://admin.hubble.cafe
      # Azure AD Security Group - only members can access admin portal
      - ALLOWED_GROUP_ID=__AZURE_GROUP_ID__

networks:
  harry-list:
  mariadb_mariadb-network:
    external: true
